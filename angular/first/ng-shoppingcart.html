<!DOCTYPE html>
<html lang="en" ng-app="myApp">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Title</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">
</head>
<body ng-controller="myCtrl">
<div class="container">
    <h2 class="text-center">购物车</h2>
    <div class="row">
        <div class="col-md-6">
            <h2 class="text-center">详情页面</h2>
            <table class="table table-bordered table-hover">
                <thead>
                <tr>
                    <th>No</th>
                    <th>品名</th>
                    <th>价格</th>
                    <th>库存</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="item in data | orderBy:'-qty'">
                    <td>{{$index+1}}</td>
                    <td>{{item.name}}</td>
                    <td class="text-right">{{item.price | currency : "¥"}}</td>
                    <td class="text-right">{{item.qty | number}}</td>
                    <td class="text-center">
                        <div ng-class="{'btn-primary':item.qty>0,'btn-defauld':item.qty==0}" ng-click="add(item)"
                             class="btn btn-xs">加入购物车
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="col-md-6">
            <h2 class="text-center">购物车页面</h2>
            <table class="table table-bordered table-hover">
                <thead>
                <tr>
                    <th>No</th>
                    <th>品名</th>
                    <th>价格</th>
                    <th>数量</th>
                    <th>总价</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
                <tr ng-repeat="item in cart track by $index">
                    <td>{{$index+1}}</td>
                    <td>{{item.name}}</td>
                    <td class="text-right">{{item.price | currency : "¥"}}</td>
                    <td class="text-right">{{item.qty | number}}</td>
                    <td class="text-right">{{item.price*item.qty | currency : "¥"}}</td>
                    <td class="text-center">
                        <div class="btn btn-default btn-xs" ng-click="del(item,$index)">删除</div>
                    </td>
                </tr>
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="2" class="text-right">
                        总金额{{}}
                    </td>
                    <td class="text-right">
                        折扣{{cart | amount:disc}}
                    </td>
                    <td class="text-right">
                        优惠多少{{}}
                    </td>
                    <td colspan="2" class="text-right">
                        实付金额{{cart | amount | currency:"¥"}}
                    </td>
                    <!--<td class="text-right">{{sum | currency : "¥"}}</td>-->
                </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>
</body>
<script src="js/angular.js"></script>
<script>
    var app = angular.module("myApp", []);
    app.filter("amount", function () {
        return function (cart) {
            var sum = 0;
            for (var i = 0; i < cart.length; i++) {
                sum += (cart[i].qty * cart[i].price)
            }
            reg = [
                {first: 200, dis: .9},
                {first: 400, dis: .85},
                {first: 600, dis: .8},
                {first: 800, dis: .75}
            ];
            var disc = 1;
            for (i = 0; i < reg.length; i++) {
                if (i == reg.length - 1) {
                    if (sum >= reg[i].first) {
                        sum = sum * reg[i].dis;
                        disc = reg[i].dis * 100 + "%"

                    }
                }
                else {
                    if (sum >= reg[i].first && sum < reg[i + 1].first) {
//                               alert(1);
                        sum = sum * reg[i].dis;
                        disc = reg[i].dis * 100 + "%"
                        alert(disc)
                    }
                }


            }
            return sum;
            return disc;
        }

    }).controller("myCtrl", ["$scope", function ($scope) {
        $scope.data = [
            {name: "键盘", price: 699.9, qty: 33},
            {name: "鼠标", price: 349.5, qty: 456},
            {name: "电脑", price: 499, qty: 5},
            {name: "手表", price: 200, qty: 213},
            {name: "棒棒糖", price: 2.5, qty: 23}
        ];


        $scope.cart = [];

        $scope.add = function (item) {
            for (i = 0; i < $scope.data.length; i++) {
                if (item == $scope.data[i]) {
                    if (item.qty > 0) {
                        item.qty--;
                        $scope.insertCart(item);
                    }
                    break;
                }
            }
            //总总价


        };


        $scope.insertCart = function (item) {
            var k = -1;   //不要写0 因为下标包括0
            for (i = 0; i < $scope.cart.length; i++) {        //循环cart，在里面找
                if ($scope.cart[i].name == item.name) {           //如果商品名相同则记住该商品名在cart里面的下标
                    k = i;
                    break;
                }
            }
            if (k > -1) {
                $scope.cart[k].qty++;
            } else {
                $scope.cart.push({
                    name: item.name,
                    price: item.price,
                    qty: 1
                })
            }
        };

        $scope.del = function (item, $index) {       //删除一整行

            for (i = 0; i < $scope.data.length; i++) {
                if ($scope.data[i].name == item.name) {
                    $scope.data[i].qty = $scope.data[i].qty + item.qty;
                    $scope.cart.splice($index, 1);
                }
            }

        };


//               $scope.reg = [
//                   {first:1000,dis:.9},
//                   {second:5000,dis:.85},
//                   {third:500000,dis:.8}
//               ]


    }]);
</script>
</html>